<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 Model-based functions | fishLengthAssess R package</title>
  <meta name="description" content="This document includes the description of fishLengthAssess R package." />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="4 Model-based functions | fishLengthAssess R package" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This document includes the description of fishLengthAssess R package." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Model-based functions | fishLengthAssess R package" />
  
  <meta name="twitter:description" content="This document includes the description of fishLengthAssess R package." />
  

<meta name="author" content="William Harford" />


<meta name="date" content="2025-06-02" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="indicator-based-functions.html"/>
<link rel="next" href="utility-functions.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">fishLengthAssess R package</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> What is fishLengthAssess?</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.1</b> Installation</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#how-to-use-fishlengthassess"><i class="fa fa-check"></i><b>1.2</b> How to use fishLengthAssess?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="r-objects-and-example-data-sets.html"><a href="r-objects-and-example-data-sets.html"><i class="fa fa-check"></i><b>2</b> R objects and example data sets</a></li>
<li class="chapter" data-level="3" data-path="indicator-based-functions.html"><a href="indicator-based-functions.html"><i class="fa fa-check"></i><b>3</b> Indicator-based functions</a>
<ul>
<li class="chapter" data-level="3.1" data-path="indicator-based-functions.html"><a href="indicator-based-functions.html#pmatfunc-function"><i class="fa fa-check"></i><b>3.1</b> <code>PmatFunc</code> function</a></li>
<li class="chapter" data-level="3.2" data-path="indicator-based-functions.html"><a href="indicator-based-functions.html#poptfunc-function"><i class="fa fa-check"></i><b>3.2</b> <code>PoptFunc</code> function</a></li>
<li class="chapter" data-level="3.3" data-path="indicator-based-functions.html"><a href="indicator-based-functions.html#pmegafunc-function"><i class="fa fa-check"></i><b>3.3</b> <code>PmegaFunc</code> function</a></li>
<li class="chapter" data-level="3.4" data-path="indicator-based-functions.html"><a href="indicator-based-functions.html#plcfunc-function"><i class="fa fa-check"></i><b>3.4</b> <code>PLcFunc</code> function</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="model-based-functions.html"><a href="model-based-functions.html"><i class="fa fa-check"></i><b>4</b> Model-based functions</a>
<ul>
<li class="chapter" data-level="4.1" data-path="model-based-functions.html"><a href="model-based-functions.html#lbsprwrapper-function"><i class="fa fa-check"></i><b>4.1</b> <code>lbsprWrapper</code> function</a></li>
<li class="chapter" data-level="4.2" data-path="model-based-functions.html"><a href="model-based-functions.html#gtg-length-based-spr-model-including-dome-shaped-selectivity"><i class="fa fa-check"></i><b>4.2</b> GTG Length-Based SPR model including dome-shaped selectivity</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="model-based-functions.html"><a href="model-based-functions.html#core-simulation-function-gtgdomelbsprsim2"><i class="fa fa-check"></i><b>4.2.1</b> Core simulation function: <code>GTGDomeLBSPRSim2</code></a></li>
<li class="chapter" data-level="4.2.2" data-path="model-based-functions.html"><a href="model-based-functions.html#data-processing-function-processlengthcompdata"><i class="fa fa-check"></i><b>4.2.2</b> Data Processing Function: <code>processLengthCompData</code></a></li>
<li class="chapter" data-level="4.2.3" data-path="model-based-functions.html"><a href="model-based-functions.html#optimization-function-optfundome"><i class="fa fa-check"></i><b>4.2.3</b> Optimization function: <code>OptFunDome</code></a></li>
<li class="chapter" data-level="4.2.4" data-path="model-based-functions.html"><a href="model-based-functions.html#optimization-wrapper-dooptdome"><i class="fa fa-check"></i><b>4.2.4</b> Optimization wrapper: <code>DoOptDome</code></a></li>
<li class="chapter" data-level="4.2.5" data-path="model-based-functions.html"><a href="model-based-functions.html#user-interface-functions"><i class="fa fa-check"></i><b>4.2.5</b> User interface functions:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="utility-functions.html"><a href="utility-functions.html"><i class="fa fa-check"></i><b>5</b> Utility functions</a>
<ul>
<li class="chapter" data-level="5.1" data-path="utility-functions.html"><a href="utility-functions.html#poollengthcomp-function"><i class="fa fa-check"></i><b>5.1</b> <code>poolLengthComp</code> function</a></li>
<li class="chapter" data-level="5.2" data-path="utility-functions.html"><a href="utility-functions.html#loptfunc-function"><i class="fa fa-check"></i><b>5.2</b> <code>LoptFunc</code> function</a></li>
<li class="chapter" data-level="5.3" data-path="utility-functions.html"><a href="utility-functions.html#lcfunc-function"><i class="fa fa-check"></i><b>5.3</b> <code>LcFunc</code> function</a></li>
<li class="chapter" data-level="5.4" data-path="utility-functions.html"><a href="utility-functions.html#fit_gillnet_dome-function-and-gillnet-selectivity-analysis"><i class="fa fa-check"></i><b>5.4</b> <code>fit_gillnet_dome</code> function and gillnet selectivity analysis</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="utility-functions.html"><a href="utility-functions.html#function-overview"><i class="fa fa-check"></i><b>5.4.1</b> Function Overview</a></li>
<li class="chapter" data-level="5.4.2" data-path="utility-functions.html"><a href="utility-functions.html#function-arguments"><i class="fa fa-check"></i><b>5.4.2</b> Function Arguments</a></li>
<li class="chapter" data-level="5.4.3" data-path="utility-functions.html"><a href="utility-functions.html#data-exploration-and-calculation-of-starting-values"><i class="fa fa-check"></i><b>5.4.3</b> Data exploration and calculation of starting values</a></li>
<li class="chapter" data-level="5.4.4" data-path="utility-functions.html"><a href="utility-functions.html#model-fitting"><i class="fa fa-check"></i><b>5.4.4</b> Model Fitting</a></li>
<li class="chapter" data-level="5.4.5" data-path="utility-functions.html"><a href="utility-functions.html#model-parameter-summary"><i class="fa fa-check"></i><b>5.4.5</b> Model parameter summary</a></li>
<li class="chapter" data-level="5.4.6" data-path="utility-functions.html"><a href="utility-functions.html#result-visualization-and-interpretation"><i class="fa fa-check"></i><b>5.4.6</b> Result visualization and interpretation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="examples.html"><a href="examples.html"><i class="fa fa-check"></i><b>6</b> Examples</a>
<ul>
<li class="chapter" data-level="6.1" data-path="examples.html"><a href="examples.html#gillnet-selectivity"><i class="fa fa-check"></i><b>6.1</b> <code>fit_gillnet_dome</code> function</a></li>
<li class="chapter" data-level="6.2" data-path="examples.html"><a href="examples.html#dome-shaped-lbspr"><i class="fa fa-check"></i><b>6.2</b> <code>GTGDomeLBSPRSim2</code> function</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">fishLengthAssess R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="model-based-functions" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> Model-based functions<a href="model-based-functions.html#model-based-functions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="lbsprwrapper-function" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> <code>lbsprWrapper</code> function<a href="model-based-functions.html#lbsprwrapper-function" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>lbsprWrapper</code> function is a wrapper function for conducting length-based stock assessment (LBSPR) using length-based SPR methods (Hordyk et al. 2016). The model can use a conventional age-structured equilibrium population model or a length-structured version that is determined by growth-type-groups to account for size-based selectivity.</p>
<p>Length frequency distribution of the stock is determined by natural mortality, fishing mortality, and length-based (LB) vulnerability to fishing. A relationship also exists between reproductive output of the population and length frequency distribution. Accordingly, measurements of the length frequency distribution can be used to infer SPR. The maximum likelihood LB-SPR estimation routine requires inputs of M/K, asymptotic length, a logistic maturity curve, coefficient of variation of asymptotic length and exponential parameter for fecundity. The former three inputs are obtained from a life history. The latter two inputs are assumed as follows: coefficient of variation of asymptotic length is specified at its default value of 0.1 and exponential parameter for fecundity is set equal to the beta parameter of the length-weight relationship or to a value of
3.0 if the beta parameter is unavailable.</p>
<p>A length data set is also required, with the following caveats. First, LBSPR bins length data to produce a length-frequency distribution. When a length data set contains raw lengths, a bin width of 1 cm is used. When a length data set contains frequencies, the bin width of the length data set is used in the LBSPR fitting routine. Second, because LBSPR estimates the parameter of logistic selectivity function during the fitting process, the gear used to collect the length data must have asymptotic selectivity. Do not use LBSPR is this assumption cannot be met. Third, LBSPR assumes size structure data are representative at face value, so instances of hyperstability in the length frequency should be treated with caution <span class="citation">(<a href="#ref-coscino_influence_2024">Coscino et al. 2024</a>)</span>. For more information on the LBSPR model the user can check the package vignette <a href="https://adrianhordyk.github.io/LBSPR/articles/LBSPR.html">here</a>.</p>
</div>
<div id="gtg-length-based-spr-model-including-dome-shaped-selectivity" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> GTG Length-Based SPR model including dome-shaped selectivity<a href="model-based-functions.html#gtg-length-based-spr-model-including-dome-shaped-selectivity" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This code is based on the GTG LBSPR framework originally developed by <span class="citation">Adrian R. Hordyk et al. (<a href="#ref-hordyk2016simple">2016b</a>)</span>, which implements a growth-type-group (GTG) approach to simulate length-based per-recruit dynamics (<a href="https://github.com/AdrianHordyk/GTG_LBSPR" class="uri">https://github.com/AdrianHordyk/GTG_LBSPR</a>).</p>
<p>The GTG LBSPR code was extended by <span class="citation">Hommik et al. (<a href="#ref-hommik2020">2020</a>)</span> (<a href="https://github.com/KHommik/DomeShaped_GTG_LBSPR" class="uri">https://github.com/KHommik/DomeShaped_GTG_LBSPR</a>) to incorporate dome-shaped selectivity models, specifically normal and log-normal curves, allowing more realistic selectivity patterns for length-based simulations in data-limited contexts.</p>
<p>This current version further expands the functionality by integrating selectivity models commonly used in gillnet fisheries, particularly those available in the TropFishR package <span class="citation">(<a href="#ref-mildenberger2017">Mildenberger, Taylor, and Wolff 2017</a>)</span>, including: Normal (common spread) model, Normal (scaled spread) model, and Lognormal model. These three selectivity models are based on the SELECT framework developed by <span class="citation">Millar and Holst (<a href="#ref-millar1997">1997</a>)</span>, which uses log-linear models for fitting gillnet and hook selectivity.</p>
<p>Additionally, the code now supports two bimodal selectivity options: bimodal normal with scaled spread and bilognorm — bimodal log-normal.</p>
<p>The new configurations allow that the dome-shaped models can be used either with aggregated mesh selectivity (as in <span class="citation">Hommik et al. (<a href="#ref-hommik2020">2020</a>)</span>) or with individual mesh-specific (specific mesh size) selectivity. In addition the new code accepts different groups of length data providing the user the opportunity to estimate F/M and SPR for each group or for the pooled data.</p>
<p>This code implements a length-based assessment approach that accounts for individual variation in growth using the Growth-Type Group (GTG) approach; supports multiple selectivity curves, including dome-shaped options; provides parameter estimation via maximum likelihood; and calculates key fisheries reference points like SPR.</p>
<p>The model is part of the R package <code>fishLengthAssess</code> and and consists of several interconnected functions:</p>
<ol style="list-style-type: decimal">
<li><p><code>GTGDomeLBSPRSim2()</code>: The core simulation function that calculates SPR based on life history parameters, fleet parameters, and size bins. This function contains all the biological and mathematical models.</p></li>
<li><p><code>processLengthCompData()</code>: Data preprocessing function that converts S4 <code>LengthComp</code> objects into the format required by the optimization functions. Handles both frequency and raw length data with options for grouped or pooled analysis.</p></li>
<li><p><code>OptFunDome</code>: The objective function used during parameter estimation. This function takes trial parameter values, runs the simulation (<code>GTGDomeLBSPRSim2()</code>), compares predicted vs observed length compositions, and returns a negative log-likelihood value.</p></li>
<li><p><code>DoOptDome</code>: The main optimization function that manages the parameter estimation process (uses <code>optim()</code>). It sets up initial parameter values, calls the optimization algorithm (which repeatedly uses <code>OptFunDome()</code> to evaluate different parameter combinations), and processes the final results including standard errors and model diagnostics.</p></li>
<li><p><code>DoOptDome.LengthComp()</code>: It is a user interface function that accepts S4 <code>LengthComp</code> objects and automatically handles data processing before calling the core optimization functions. It provides options for analyzing multiple groups separately (<code>byGroup = TRUE</code>) or combining them into a single analysis (<code>byGroup = FALSE</code>).</p></li>
<li><p><code>DoOptDome.aggregated()</code>: It is a user interface function that ensures data from multiple groups is always combined (pooled) before analysis, regardless of the original data structure. This is useful when the user wants to analyze the combined dataset.</p></li>
<li><p><code>run_grouped_and_pooled()</code>: This function provides a comparative analysis that automatically runs the same dataset through both grouped analysis (each group fitted separately) and pooled analysis (all groups combined), allowing users to compare results and assess whether pooling affects parameter estimates.</p></li>
</ol>
<div id="core-simulation-function-gtgdomelbsprsim2" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Core simulation function: <code>GTGDomeLBSPRSim2</code><a href="model-based-functions.html#core-simulation-function-gtgdomelbsprsim2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This is the main function of the model. <code>GTGDomeLBSPRSim2()</code> simulates per-recruit population dynamics for fish populations structured by Growth-Type Groups (GTGs), allowing for dome-shaped or logistic selectivity curves. It supports mesh-specific or aggregated selectivity and returns biological reference points such as spawning potential ratio (SPR), yield per recruit (YPR), and equilibrium recruitment.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="model-based-functions.html#cb11-1" tabindex="-1"></a>GTGDomeLBSPRSim2 <span class="ot">&lt;-</span> <span class="cf">function</span>(lifeHistoryObj, FleetPars, <span class="at">SizeBins=</span><span class="cn">NULL</span>)</span></code></pre></div>
<div id="arguments" class="section level4 hasAnchor" number="4.2.1.1">
<h4><span class="header-section-number">4.2.1.1</span> Arguments<a href="model-based-functions.html#arguments" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The arguments of the <code>GTGDomeLBSPRSim2()</code> function are:</p>
<ul>
<li><strong><code>lifeHistoryObj</code>:</strong> S4 life history object containing biological parameters (growth, maturity, etc.).</li>
<li><strong><code>FleetPars</code>:</strong> List containing fishery parameters (selectivity, fishing mortality).</li>
<li><strong><code>SizeBins</code>:</strong> List defining length bins for analysis.</li>
</ul>
<p><strong><code>lifeHistoryObj</code>(S4 Object):</strong></p>
<p>The life history object (<code>lifeHistoryObj</code>) contains the following slots accessed via <code>@</code>:</p>
<ul>
<li><code>@Linf</code>: Mean asymptotic length</li>
<li><code>@MK</code>: M/K ratio (natural mortality over growth)</li>
<li><code>@L50</code>: Length at 50% maturity</li>
<li><code>@L95delta</code>: Delta between <code>L95</code> and <code>L50</code> maturity (<code>L95 = L50 + L95delta</code>)</li>
<li><code>@LW_A</code>, <code>@LW_B</code>: Weight-at-length coefficients (<code>Walpha</code>, <code>Wbeta</code>)</li>
<li><code>@Steep</code>: Beverton-Holt steepness</li>
<li><code>@R0</code>: Virgin recruitment (can be a large arbitrary number, e.g., 1e6)</li>
</ul>
<p>Additional attributes are added to this <code>lifeHistoryObj</code> via <code>attr()</code>:</p>
<ul>
<li><code>NGTG</code>: Number of growth-type groups (default = 13)</li>
<li><code>CVLinf</code>: Coefficient of variation in Linf (default = 0.1)</li>
<li><code>MaxSD</code>: Multiplier of SD to define GTG range (default = 2)</li>
<li><code>GTGLinfBy</code>: Increment between GTG Linf values (default = NA)</li>
<li><code>FecB</code>: Fecundity exponent (default = 3)</li>
<li><code>Mpow</code>: Exponent for M/K ratio (default = 0)</li>
</ul>
<p><strong><code>FleetPars</code>:</strong></p>
<p>Required elements:</p>
<ul>
<li><p><code>FM</code>: Fishing mortality rate (F/M)</p></li>
<li><p><code>selectivityCurve</code>: One of the following supported selectivity curves</p>
<ul>
<li><strong><code>"Logistic"</code></strong>: Two-parameter logistic selectivity (SL1: size at length of 50% of selectivity and SL2: size at length of 95% of selectivity).</li>
<li><code>"Knife"</code>: Binary selectivity above a threshold length</li>
<li><code>"Normal.loc"</code>: Normal (common spread) model</li>
<li><code>"Normal.sca"</code>: Normal (scaled spread) model</li>
<li><code>"lognorm"</code>: Lognormal model</li>
<li><code>"binorm.sca"</code>: Bi-normal model</li>
<li><code>"bilognorm"</code>: Bi-lognormal model</li>
</ul></li>
</ul>
<p>A complete description of dome-shaped selectivity curves is provided in <strong>Section 5: Utility functions</strong>.</p>
<p>Selectivity specific parameters:</p>
<ul>
<li><code>SL1</code>-<code>SL5</code>: Selectivity parameters (see table below)</li>
<li><code>SLmesh</code>: Vector of mesh sizes (for dome-shaped models)</li>
<li><code>SLMin</code>: (Optional) Minimum length selected</li>
<li><code>MLLKnife</code>: Minimum legal length (for “Knife” selectivity)</li>
<li><code>use_aggregated</code>: If TRUE, aggregate selectivity across mesh sizes</li>
<li><code>fishery_mesh</code>: (Optional) mesh size used if not aggregated</li>
</ul>
<table>
<colgroup>
<col width="39%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th>Selectivity Type</th>
<th><code>SL1</code></th>
<th><code>SL2</code></th>
<th><code>SL3</code></th>
<th><code>SL4</code></th>
<th><code>SL5</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong><code>"Logistic"</code></strong></td>
<td>Length at 50% selectivity</td>
<td>Length at 95% selectivity</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr class="even">
<td><strong><code>"Normal.loc"</code></strong></td>
<td>Mode of normal curve</td>
<td>Spread (SD) (fixed)</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr class="odd">
<td><strong><code>"Normal.sca"</code></strong></td>
<td>Mode of normal curve</td>
<td>Spread (SD) (proportional to mesh)</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr class="even">
<td><strong><code>"logNorm"</code></strong></td>
<td>Parameter mean in log space</td>
<td>Parameter SD in log space</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
<tr class="odd">
<td><strong><code>"binorm.sca"</code></strong></td>
<td>Mode 1 (first peak)</td>
<td>SD 1</td>
<td>Mode 2 (second peak)</td>
<td>SD 2</td>
<td>Logit(P1): proportion of retention assigned to the first peak</td>
</tr>
<tr class="even">
<td><strong><code>"bilognorm"</code></strong></td>
<td>Mode 1 (first peak in log space)</td>
<td>SD 1 in log space</td>
<td>Mode 2 (second peak in log space)</td>
<td>SD 2 in log space</td>
<td>Logit(P1): proportion of retention assigned to the first peak</td>
</tr>
<tr class="odd">
<td><strong><code>"Knife"</code></strong></td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
<td>—</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> In bimodal models, <code>SL5</code> is a logit-transformed parameter that represents the proportion of retention assigned to the first peak.</p>
<p><span class="math display">\[
P_1 = \frac{\exp(\text{SL5})}{1 + \exp(\text{SL5})}
\]</span>
A complete description of dome-shaped selectivity parameters is provided in <strong>Section 5: Utility functions</strong>.</p>
<p><strong><code>SizeBins</code>:</strong></p>
<p>Required elements:</p>
<ul>
<li><code>Linc</code>: Bin width (default = 1)</li>
<li><code>ToSize</code>: Upper bound for length classes (default = Linf + MaxSD * SD_Linf)</li>
</ul>
</div>
<div id="parameter-extraction-and-setup-of-gtgdomelbsprsim2" class="section level4 hasAnchor" number="4.2.1.2">
<h4><span class="header-section-number">4.2.1.2</span> Parameter extraction and setup of <code>GTGDomeLBSPRSim2()</code><a href="model-based-functions.html#parameter-extraction-and-setup-of-gtgdomelbsprsim2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="model-based-functions.html#cb12-1" tabindex="-1"></a><span class="co"># Direct S4 access to lifeHistoryObj </span></span>
<span id="cb12-2"><a href="model-based-functions.html#cb12-2" tabindex="-1"></a>NGTG <span class="ot">&lt;-</span> <span class="fu">attr</span>(lifeHistoryObj, <span class="st">&quot;NGTG&quot;</span>)</span>
<span id="cb12-3"><a href="model-based-functions.html#cb12-3" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(NGTG)) NGTG <span class="ot">&lt;-</span> <span class="dv">13</span>  <span class="co"># Default</span></span>
<span id="cb12-4"><a href="model-based-functions.html#cb12-4" tabindex="-1"></a>Linf <span class="ot">&lt;-</span> lifeHistoryObj<span class="sc">@</span>Linf</span>
<span id="cb12-5"><a href="model-based-functions.html#cb12-5" tabindex="-1"></a>MK <span class="ot">&lt;-</span> lifeHistoryObj<span class="sc">@</span>MK</span>
<span id="cb12-6"><a href="model-based-functions.html#cb12-6" tabindex="-1"></a>L50 <span class="ot">&lt;-</span> lifeHistoryObj<span class="sc">@</span>L50</span>
<span id="cb12-7"><a href="model-based-functions.html#cb12-7" tabindex="-1"></a>L95 <span class="ot">&lt;-</span> lifeHistoryObj<span class="sc">@</span>L50 <span class="sc">+</span> lifeHistoryObj<span class="sc">@</span>L95delta  <span class="co"># Convert from delta</span></span>
<span id="cb12-8"><a href="model-based-functions.html#cb12-8" tabindex="-1"></a><span class="co"># ... more parameters extracted</span></span></code></pre></div>
<p>The function first extracts biological parameters from the S4 life history object <code>lifeHistoryObj</code>, including:</p>
<ul>
<li>Growth parameters (<code>Linf</code>, <code>CV</code>) via direct slot access (<code>@</code>) and attribute access (attr())</li>
<li>Mortality-to-growth ratio (<code>M/K</code>)</li>
<li>Maturity parameters (<code>L50</code>, <code>L95delta</code>)</li>
<li>Weight-length relationship (<code>LW_A</code>, <code>LW_B</code>)</li>
<li>Fecundity parameters</li>
</ul>
</div>
<div id="setting-up-growth-type-groups-gtgs" class="section level4 hasAnchor" number="4.2.1.3">
<h4><span class="header-section-number">4.2.1.3</span> Setting up Growth-Type Groups (GTGs)<a href="model-based-functions.html#setting-up-growth-type-groups-gtgs" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The function creates a range of <code>Linf</code> values centered on the mean <code>Linf</code> and distributes recruits across these groups. This accounts for individual variability in growth.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="model-based-functions.html#cb13-1" tabindex="-1"></a><span class="co"># Set up Linfs for different GTGs</span></span>
<span id="cb13-2"><a href="model-based-functions.html#cb13-2" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;NGTG&quot;</span>) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;GTGLinfBy&quot;</span>)) {</span>
<span id="cb13-3"><a href="model-based-functions.html#cb13-3" tabindex="-1"></a>  DiffLinfs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span>Linf<span class="sc">-</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">to=</span>Linf<span class="sc">+</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">length=</span>NGTG)</span>
<span id="cb13-4"><a href="model-based-functions.html#cb13-4" tabindex="-1"></a>  GTGLinfBy <span class="ot">&lt;-</span> DiffLinfs[<span class="dv">2</span>]<span class="sc">-</span>DiffLinfs[<span class="dv">1</span>]</span>
<span id="cb13-5"><a href="model-based-functions.html#cb13-5" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">&quot;NGTG&quot;</span>) <span class="sc">&amp;</span> <span class="fu">exists</span>(<span class="st">&quot;GTGLinfBy&quot;</span>)) {</span>
<span id="cb13-6"><a href="model-based-functions.html#cb13-6" tabindex="-1"></a>  DiffLinfs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span>Linf<span class="sc">-</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">to=</span>Linf<span class="sc">+</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">by=</span>GTGLinfBy)</span>
<span id="cb13-7"><a href="model-based-functions.html#cb13-7" tabindex="-1"></a>  NGTG <span class="ot">&lt;-</span> <span class="fu">length</span>(DiffLinfs)</span>
<span id="cb13-8"><a href="model-based-functions.html#cb13-8" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">&quot;NGTG&quot;</span>) <span class="sc">&amp;</span> <span class="fu">exists</span>(<span class="st">&quot;GTGLinfBy&quot;</span>)) {</span>
<span id="cb13-9"><a href="model-based-functions.html#cb13-9" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(GTGLinfBy)) {</span>
<span id="cb13-10"><a href="model-based-functions.html#cb13-10" tabindex="-1"></a>    DiffLinfs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span>Linf<span class="sc">-</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">to=</span>Linf<span class="sc">+</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">by=</span>GTGLinfBy)</span>
<span id="cb13-11"><a href="model-based-functions.html#cb13-11" tabindex="-1"></a>    NGTG <span class="ot">&lt;-</span> <span class="fu">length</span>(DiffLinfs)</span>
<span id="cb13-12"><a href="model-based-functions.html#cb13-12" tabindex="-1"></a>  } </span>
<span id="cb13-13"><a href="model-based-functions.html#cb13-13" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(GTGLinfBy)) {</span>
<span id="cb13-14"><a href="model-based-functions.html#cb13-14" tabindex="-1"></a>    DiffLinfs <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span>Linf<span class="sc">-</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">to=</span>Linf<span class="sc">+</span>MaxSD<span class="sc">*</span>SDLinf, <span class="at">length=</span>NGTG)</span>
<span id="cb13-15"><a href="model-based-functions.html#cb13-15" tabindex="-1"></a>    GTGLinfBy <span class="ot">&lt;-</span> DiffLinfs[<span class="dv">2</span>]<span class="sc">-</span>DiffLinfs[<span class="dv">1</span>]</span>
<span id="cb13-16"><a href="model-based-functions.html#cb13-16" tabindex="-1"></a>  }  </span>
<span id="cb13-17"><a href="model-based-functions.html#cb13-17" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="selectivity-model-implementation" class="section level4 hasAnchor" number="4.2.1.4">
<h4><span class="header-section-number">4.2.1.4</span> Selectivity model implementation<a href="model-based-functions.html#selectivity-model-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A major feature of this model is its ability to use different selectivity curves:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="model-based-functions.html#cb14-1" tabindex="-1"></a><span class="cf">if</span>(selectivityCurve<span class="sc">==</span><span class="st">&quot;Logistic&quot;</span>){</span>
<span id="cb14-2"><a href="model-based-functions.html#cb14-2" tabindex="-1"></a>  VulLen <span class="ot">&lt;-</span> <span class="fl">1.0</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span><span class="fu">log</span>(<span class="dv">19</span>)<span class="sc">*</span>((LenBins<span class="fl">+0.5</span><span class="sc">*</span>Linc)<span class="sc">-</span>SL50)<span class="sc">/</span>((SL95)<span class="sc">-</span>(SL50))))</span>
<span id="cb14-3"><a href="model-based-functions.html#cb14-3" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(selectivityCurve<span class="sc">==</span><span class="st">&quot;Normal.sca&quot;</span>){</span>
<span id="cb14-4"><a href="model-based-functions.html#cb14-4" tabindex="-1"></a>  <span class="co"># Normal Scale implementation</span></span>
<span id="cb14-5"><a href="model-based-functions.html#cb14-5" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb14-6"><a href="model-based-functions.html#cb14-6" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(selectivityCurve<span class="sc">==</span><span class="st">&quot;Normal.loc&quot;</span>){</span>
<span id="cb14-7"><a href="model-based-functions.html#cb14-7" tabindex="-1"></a>  <span class="co"># Normal Location implementation</span></span>
<span id="cb14-8"><a href="model-based-functions.html#cb14-8" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb14-9"><a href="model-based-functions.html#cb14-9" tabindex="-1"></a>}</span>
<span id="cb14-10"><a href="model-based-functions.html#cb14-10" tabindex="-1"></a><span class="co"># ... more selectivity options</span></span></code></pre></div>
<p>The model supports both mesh-aggregated and single-mesh selectivity for dome-shaped curves.</p>
</div>
<div id="population-dynamics-simulation" class="section level4 hasAnchor" number="4.2.1.5">
<h4><span class="header-section-number">4.2.1.5</span> Population dynamics simulation<a href="model-based-functions.html#population-dynamics-simulation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The function simulates both unfished and fished populations, tracking numbers, biomass, and reproductive output across length classes and growth-type groups.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="model-based-functions.html#cb15-1" tabindex="-1"></a><span class="co"># Initialize matrices</span></span>
<span id="cb15-2"><a href="model-based-functions.html#cb15-2" tabindex="-1"></a>NPRFished <span class="ot">&lt;-</span> NPRUnfished <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="fu">length</span>(LenBins), <span class="at">ncol=</span>NGTG)</span>
<span id="cb15-3"><a href="model-based-functions.html#cb15-3" tabindex="-1"></a><span class="co"># ... more matrices</span></span>
<span id="cb15-4"><a href="model-based-functions.html#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="model-based-functions.html#cb15-5" tabindex="-1"></a><span class="co"># Distribute recruits to first length class</span></span>
<span id="cb15-6"><a href="model-based-functions.html#cb15-6" tabindex="-1"></a>NPRFished[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> NPRUnfished[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> RecProbs <span class="sc">*</span> R0</span>
<span id="cb15-7"><a href="model-based-functions.html#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="model-based-functions.html#cb15-8" tabindex="-1"></a><span class="co"># Calculate numbers at each size class</span></span>
<span id="cb15-9"><a href="model-based-functions.html#cb15-9" tabindex="-1"></a><span class="cf">for</span> (L <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(LenBins)) {</span>
<span id="cb15-10"><a href="model-based-functions.html#cb15-10" tabindex="-1"></a>  NPRUnfished[L, ] <span class="ot">&lt;-</span> NPRUnfished[L<span class="dv">-1</span>, ] <span class="sc">*</span> ((DiffLinfs<span class="sc">-</span>LenBins[L])<span class="sc">/</span>(DiffLinfs<span class="sc">-</span>LenBins[L<span class="dv">-1</span>]))<span class="sc">^</span>MKMat[L<span class="dv">-1</span>, ]</span>
<span id="cb15-11"><a href="model-based-functions.html#cb15-11" tabindex="-1"></a>  NPRFished[L, ] <span class="ot">&lt;-</span> NPRFished[L<span class="dv">-1</span>, ] <span class="sc">*</span> ((DiffLinfs<span class="sc">-</span>LenBins[L])<span class="sc">/</span>(DiffLinfs<span class="sc">-</span>LenBins[L<span class="dv">-1</span>]))<span class="sc">^</span>ZKLMat[L<span class="dv">-1</span>, ]</span>
<span id="cb15-12"><a href="model-based-functions.html#cb15-12" tabindex="-1"></a>  <span class="co"># ... more calculations</span></span>
<span id="cb15-13"><a href="model-based-functions.html#cb15-13" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="spr-and-yield-calculation" class="section level4 hasAnchor" number="4.2.1.6">
<h4><span class="header-section-number">4.2.1.6</span> SPR and Yield calculation<a href="model-based-functions.html#spr-and-yield-calculation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The function calculates SPR as the ratio of eggs-per-recruit in the fished vs. unfished population, as well as yield-per-recruit and total yield.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="model-based-functions.html#cb16-1" tabindex="-1"></a><span class="co"># Calculate SPR</span></span>
<span id="cb16-2"><a href="model-based-functions.html#cb16-2" tabindex="-1"></a>EPR0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(NatLUnFishedPop <span class="sc">*</span> FecLenGTG)  <span class="co"># Eggs-per-recruit Unfished</span></span>
<span id="cb16-3"><a href="model-based-functions.html#cb16-3" tabindex="-1"></a>EPRf <span class="ot">&lt;-</span> <span class="fu">sum</span>(NatLFishedPop <span class="sc">*</span> FecLenGTG)  <span class="co"># Eggs-per-recruit Fished</span></span>
<span id="cb16-4"><a href="model-based-functions.html#cb16-4" tabindex="-1"></a>SPR <span class="ot">&lt;-</span> EPRf<span class="sc">/</span>EPR0  <span class="co"># Spawning potential ratio</span></span>
<span id="cb16-5"><a href="model-based-functions.html#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="model-based-functions.html#cb16-6" tabindex="-1"></a><span class="co"># Calculate yield</span></span>
<span id="cb16-7"><a href="model-based-functions.html#cb16-7" tabindex="-1"></a>YPR <span class="ot">&lt;-</span> <span class="fu">sum</span>(NatLFishedPop <span class="sc">*</span> Weight <span class="sc">*</span> VulLen2) <span class="sc">*</span> FM</span>
<span id="cb16-8"><a href="model-based-functions.html#cb16-8" tabindex="-1"></a>Yield <span class="ot">&lt;-</span> YPR <span class="sc">*</span> RelRec</span></code></pre></div>
</div>
<div id="main-outputs-of-the-gtgdomelbsprsim2-function" class="section level4 hasAnchor" number="4.2.1.7">
<h4><span class="header-section-number">4.2.1.7</span> Main outputs of the <code>GTGDomeLBSPRSim2()</code> function<a href="model-based-functions.html#main-outputs-of-the-gtgdomelbsprsim2-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The function returns a comprehensive list of calculated values, including:</p>
<table>
<colgroup>
<col width="37%" />
<col width="62%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>SPR</code></td>
<td>Spawning Potential Ratio</td>
</tr>
<tr class="even">
<td><code>YPR</code>, <code>Yield</code></td>
<td>Yield per recruit and total yield</td>
</tr>
<tr class="odd">
<td><code>LCatchFished</code>, <code>LCatchUnfished</code></td>
<td>Normalized length composition of catch (fished and unfished)</td>
</tr>
<tr class="even">
<td><code>LPopFished</code>, <code>LPopUnfished</code></td>
<td>Normalized population-at-length (fished and unfished)</td>
</tr>
<tr class="odd">
<td><code>NatLPopFished</code>, <code>NatLPopUnFish</code></td>
<td>Raw GTG-specific number-at-length matrices (fished and unfished)</td>
</tr>
<tr class="even">
<td><code>NatLCatchFish</code>, <code>NatLCatchUnFish</code></td>
<td>GTG-specific catch matrices (fish and unfished)</td>
</tr>
<tr class="odd">
<td><code>FecLen</code>, <code>MatLen</code></td>
<td>Fecundity and maturity-at-length per GTG</td>
</tr>
<tr class="even">
<td><code>SelLen</code>, <code>VulLen2</code></td>
<td>Selectivity-at-length vectors (bins and mids)</td>
</tr>
<tr class="odd">
<td><code>ObjFun</code></td>
<td>Fitness deviation metric (for optimization)</td>
</tr>
<tr class="even">
<td><code>SPRatsize</code></td>
<td>Cumulative SPR by size class</td>
</tr>
<tr class="odd">
<td><code>RecProbs</code>, <code>RelRec</code></td>
<td>Recruitment probability and equilibrium recruitment</td>
</tr>
<tr class="even">
<td>…</td>
<td>Other additional diagnostic variables for plotting and analysis</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="data-processing-function-processlengthcompdata" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Data Processing Function: <code>processLengthCompData</code><a href="model-based-functions.html#data-processing-function-processlengthcompdata" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>processLengthCompData()</code> function processes S4 <code>LengthComp</code> objects for use in the GTG dome-shaped LBSPR model, handling both frequency and raw length data with support for grouped or pooled analysis.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="model-based-functions.html#cb17-1" tabindex="-1"></a><span class="fu">processLengthCompData</span>(LengthCompObj, <span class="at">byGroup =</span> <span class="cn">FALSE</span>, <span class="at">SizeBins =</span> <span class="cn">NULL</span>, <span class="at">Lc =</span> <span class="dv">0</span>)</span></code></pre></div>
<div id="arguments-1" class="section level4 hasAnchor" number="4.2.2.1">
<h4><span class="header-section-number">4.2.2.1</span> Arguments<a href="model-based-functions.html#arguments-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><code>LengthCompObj</code>: S4 <code>LengthComp</code> object containing length data</li>
<li><code>byGroup</code>: Logical, whether to process by group (default FALSE). If TRUE, analyzes each group separately; if FALSE, pools all data together.</li>
<li><code>SizeBins</code>: List with Linc and ToSize elements (optional). If NULL, defaults to 1 cm bins up to reasonable maximum size.</li>
<li><code>Lc</code>: Length at first capture (default 0). For fishery-independent data, must be &gt;= 0. Fish smaller than <code>Lc</code> are removed from analysis.</li>
</ul>
</div>
<div id="data-processing-steps" class="section level4 hasAnchor" number="4.2.2.2">
<h4><span class="header-section-number">4.2.2.2</span> Data processing steps<a href="model-based-functions.html#data-processing-steps" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li>Input Validation: Checks S4 object structure and parameter consistency.</li>
<li>Data Extraction: Uses poolLengthComp() to extract data from S4 structure.</li>
<li>Binning: For raw length data, creates frequency distributions using hist().</li>
<li>Filtering: Removes fish below Lc for fishery-independent (FI) data.</li>
<li>Group Handling: Manages multiple groups based on <code>byGroup</code> argument.</li>
</ul>
</div>
<div id="main-outputs-of-the-processlengthcompdata-function" class="section level4 hasAnchor" number="4.2.2.3">
<h4><span class="header-section-number">4.2.2.3</span> Main outputs of the <code>processLengthCompData()</code> function<a href="model-based-functions.html#main-outputs-of-the-processlengthcompdata-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The data processing function <code>processLengthCompData()</code> returns a list containing processed length data:</p>
<table>
<colgroup>
<col width="42%" />
<col width="57%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>LenDat</code></td>
<td>Frequency matrix or vector</td>
</tr>
<tr class="even">
<td><code>LenMids</code></td>
<td>Length bin midpoints</td>
</tr>
<tr class="odd">
<td><code>group_names</code></td>
<td>Group identifiers</td>
</tr>
<tr class="even">
<td><code>n_groups</code></td>
<td>Number of groups</td>
</tr>
<tr class="odd">
<td><code>was_pooled</code></td>
<td>Whether data was pooled</td>
</tr>
<tr class="even">
<td><code>original_dataType</code></td>
<td>“Frequency” or “Length</td>
</tr>
<tr class="odd">
<td><code>L_source</code></td>
<td>“FI” or “FD”</td>
</tr>
<tr class="even">
<td><code>pooled_data</code></td>
<td>Raw processed data frame</td>
</tr>
<tr class="odd">
<td><code>binWidth</code></td>
<td>Length bin width used</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="optimization-function-optfundome" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> Optimization function: <code>OptFunDome</code><a href="model-based-functions.html#optimization-function-optfundome" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>OptFunDome()</code> function evaluates how well a proposed set of selectivity and fishing mortality parameters fit observed length-frequency data using a per-recruit simulation and multinomial likelihood.
It is used as the objective function in an optimization routine (e.g., within <code>optim()</code>), where the goal is to minimize the negative log-likelihood (NLL) of the predicted length composition relative to observed data.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="model-based-functions.html#cb18-1" tabindex="-1"></a><span class="fu">OptFunDome</span>(tryFleetPars, fixedFleetPars, LenDat, lifeHistoryObj, </span>
<span id="cb18-2"><a href="model-based-functions.html#cb18-2" tabindex="-1"></a>          <span class="at">SizeBins =</span> <span class="cn">NULL</span>, <span class="at">mod =</span> <span class="fu">c</span>(<span class="st">&quot;GTG&quot;</span>, <span class="st">&quot;LBSPR&quot;</span>))</span></code></pre></div>
<div id="arguments-2" class="section level4 hasAnchor" number="4.2.3.1">
<h4><span class="header-section-number">4.2.3.1</span> Arguments<a href="model-based-functions.html#arguments-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><p><code>tryFleetPars</code>: A numeric vector of parameters to estimate (typically log-transformed). For logistic selectivity with estimation, <code>tryFleetPars = c(log(F/M), log(SL50/Linf), log((SL95 - SL50)/Linf))</code>. If logistic selectivity parameters are being estimated, a penalty is added to the objective function if <code>SL50</code> approaches unrealistic values (i.e., too close to <code>Linf</code>). The penalty is based on a beta distribution.
For dome-shaped models (selectivity is fixed)), <code>tryFleetPars = c(log(F/M))</code>.</p></li>
<li><p><code>fixedFleetPars</code>: A list of selectivity model parameters to keep fixed during optimization. This must include the <code>selectivityCurve</code> name and any other parameters (e.g., <code>SL1</code>–<code>SL5</code>, <code>SLmesh</code>, etc).</p></li>
<li><p><code>LenDat</code>: A vector of observed length-frequency data (number of fish in each length bin).</p></li>
<li><p><code>lifeHistoryObj</code>: S4 life history object (same as in <code>GTGDomeLBSPRSim2()</code>)</p></li>
<li><p><code>SizeBins</code>: Same as in the <code>GTGDomeLBSPRSim2()</code> function</p></li>
<li><p><code>mod</code>: Model type (<code>character</code>); only <code>"GTG"</code> is supported (uses growth-type group model).</p></li>
</ul>
</div>
<div id="key-steps-in-the-function-optfundome" class="section level4 hasAnchor" number="4.2.3.2">
<h4><span class="header-section-number">4.2.3.2</span> Key steps in the function <code>OptFunDome()</code><a href="model-based-functions.html#key-steps-in-the-function-optfundome" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The function sets up fleet parameters based on inputs, runs the simulation model, and calculates the negative log-likelihood between observed and predicted length distributions.
The main output is a single numeric value that represents the negative log-likelihood (<code>NLL</code>) of the predicted vs. observed length distribution, including a penalty if logistic parameters are being estimated and <code>SL1</code> approaches unrealistic values (too close to <code>Linf</code>).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="model-based-functions.html#cb19-1" tabindex="-1"></a><span class="co"># Set up fleet parameters</span></span>
<span id="cb19-2"><a href="model-based-functions.html#cb19-2" tabindex="-1"></a>Fleet <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb19-3"><a href="model-based-functions.html#cb19-3" tabindex="-1"></a>Fleet<span class="sc">$</span>selectivityCurve <span class="ot">&lt;-</span> fixedFleetPars<span class="sc">$</span>selectivityCurve</span>
<span id="cb19-4"><a href="model-based-functions.html#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="model-based-functions.html#cb19-5" tabindex="-1"></a><span class="co"># Set selectivity parameters based on curve type</span></span>
<span id="cb19-6"><a href="model-based-functions.html#cb19-6" tabindex="-1"></a><span class="cf">if</span>(Fleet<span class="sc">$</span>selectivityCurve<span class="sc">==</span><span class="st">&quot;Logistic&quot;</span>){</span>
<span id="cb19-7"><a href="model-based-functions.html#cb19-7" tabindex="-1"></a>  <span class="co"># ... set logistic parameters</span></span>
<span id="cb19-8"><a href="model-based-functions.html#cb19-8" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(Fleet<span class="sc">$</span>selectivityCurve<span class="sc">==</span><span class="st">&quot;Knife&quot;</span>){</span>
<span id="cb19-9"><a href="model-based-functions.html#cb19-9" tabindex="-1"></a>  <span class="co"># ... set knife-edge parameters</span></span>
<span id="cb19-10"><a href="model-based-functions.html#cb19-10" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span>(Fleet<span class="sc">$</span>selectivityCurve <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Normal.sca&quot;</span>, <span class="st">&quot;Normal.loc&quot;</span>, <span class="st">&quot;logNorm&quot;</span>, <span class="st">&quot;binorm.sca&quot;</span>,<span class="st">&quot;bilognorm&quot;</span>)){</span>
<span id="cb19-11"><a href="model-based-functions.html#cb19-11" tabindex="-1"></a>  <span class="co"># ... set dome-shaped parameters</span></span>
<span id="cb19-12"><a href="model-based-functions.html#cb19-12" tabindex="-1"></a>}</span>
<span id="cb19-13"><a href="model-based-functions.html#cb19-13" tabindex="-1"></a></span>
<span id="cb19-14"><a href="model-based-functions.html#cb19-14" tabindex="-1"></a><span class="co"># Set fishing mortality</span></span>
<span id="cb19-15"><a href="model-based-functions.html#cb19-15" tabindex="-1"></a>Fleet<span class="sc">$</span>FM <span class="ot">&lt;-</span> <span class="fu">exp</span>(tryFleetPars[<span class="dv">1</span>])</span>
<span id="cb19-16"><a href="model-based-functions.html#cb19-16" tabindex="-1"></a></span>
<span id="cb19-17"><a href="model-based-functions.html#cb19-17" tabindex="-1"></a><span class="co"># Run the simulation model</span></span>
<span id="cb19-18"><a href="model-based-functions.html#cb19-18" tabindex="-1"></a>runMod <span class="ot">&lt;-</span> <span class="fu">GTGDomeLBSPRSim2</span>(lifeHistoryObj, Fleet, SizeBins)</span>
<span id="cb19-19"><a href="model-based-functions.html#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a href="model-based-functions.html#cb19-20" tabindex="-1"></a><span class="co"># Calculate negative log-likelihood</span></span>
<span id="cb19-21"><a href="model-based-functions.html#cb19-21" tabindex="-1"></a>LenDat <span class="ot">&lt;-</span> LenDat <span class="sc">+</span> <span class="fl">1E-15</span>  <span class="co"># Add tiny constant to avoid log(0)</span></span>
<span id="cb19-22"><a href="model-based-functions.html#cb19-22" tabindex="-1"></a>LenProb <span class="ot">&lt;-</span> LenDat<span class="sc">/</span><span class="fu">sum</span>(LenDat)  <span class="co"># Observed proportions</span></span>
<span id="cb19-23"><a href="model-based-functions.html#cb19-23" tabindex="-1"></a>predProb <span class="ot">&lt;-</span> runMod<span class="sc">$</span>LCatchFished  <span class="co"># Predicted proportions</span></span>
<span id="cb19-24"><a href="model-based-functions.html#cb19-24" tabindex="-1"></a>predProb <span class="ot">&lt;-</span> predProb <span class="sc">+</span> <span class="fl">1E-15</span>  <span class="co"># Add tiny constant</span></span>
<span id="cb19-25"><a href="model-based-functions.html#cb19-25" tabindex="-1"></a>NLL <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(LenDat <span class="sc">*</span> <span class="fu">log</span>(predProb<span class="sc">/</span>LenProb))  <span class="co"># Negative log-likelihood</span></span></code></pre></div>
</div>
</div>
<div id="optimization-wrapper-dooptdome" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> Optimization wrapper: <code>DoOptDome</code><a href="model-based-functions.html#optimization-wrapper-dooptdome" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This function manages the optimization process to estimate parameters. The function <code>DoOptDome()</code> is the wrapper that runs the full optimization process. It tries to find the best values for fishing mortality (<code>F/M</code>) and, if needed, selectivity parameters like <code>SL1</code> and <code>SL1</code> (only for logistic selectivity). To do that, it uses <code>OptFunDome()</code>(i.e., the objective function) to evaluates the likelihood for a given parameter set.</p>
<p>This function performs maximum likelihood estimation of fishing mortality and, optionally, selectivity parameters based on observed length-frequency data. It uses a per-recruit simulation (<code>GTGDomeLBSPRSim2()</code>) under the Growth-Type Group <code>("GTG")</code> model framework, and compares observed and predicted length distributions using a multinomial likelihood.</p>
<div id="arguments-3" class="section level4 hasAnchor" number="4.2.4.1">
<h4><span class="header-section-number">4.2.4.1</span> Arguments<a href="model-based-functions.html#arguments-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ul>
<li><p><code>lifeHistoryObj</code>: S4 life history object containing biological parameters</p></li>
<li><p><code>fixedFleetPars</code>: A list of fixed fishing/selectivity parameters, including <code>selectivityCurve</code> name, values for <code>SL1</code>–<code>SL5</code>, <code>SLmesh</code>, <code>SLMin</code>, <code>use_aggregated</code>, and <code>fishery_mesh</code>.</p></li>
<li><p><code>LenDat</code>: A numeric vector. The observed length-frequency data (e.g., counts per length bin).</p></li>
<li><p><code>SizeBins</code>: A list or NULL. A list with Linc (length bin width) and ToSize (maximum length). Defaults are created if not provided.</p></li>
<li><p><code>mod</code>: A character. Currently only “GTG” is supported by this code.</p></li>
</ul>
<p>The function sets up initial parameter values and runs the optimization using either BFGS (when estimating F/M and logistic selectivity) or Brent (when estimating only F/M and dome-shaped selectivity is fixed) methods:</p>
</div>
<div id="main-outputs-of-the-dooptdome-function" class="section level4 hasAnchor" number="4.2.4.2">
<h4><span class="header-section-number">4.2.4.2</span> Main outputs of the <code>DoOptDome()</code> function<a href="model-based-functions.html#main-outputs-of-the-dooptdome-function" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The <code>DoOptDome()</code> function returns a list containing:</p>
<table>
<colgroup>
<col width="42%" />
<col width="57%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>lbPars</code></td>
<td>Estimated parameters: <code>F/M</code>, <code>SL1</code> and <code>SL2</code> (if logistic is estimated), and <code>SPR</code> (derived quantity)</td>
</tr>
<tr class="even">
<td><code>lbStdErrs</code></td>
<td>Standard errors of the estimated parameters</td>
</tr>
<tr class="odd">
<td><code>fixedFleetPars</code></td>
<td>Original (fixed) selectivity settings.</td>
</tr>
<tr class="even">
<td><code>PredLen</code></td>
<td>Predicted length-frequency data (expected catch numbers by length bin)</td>
</tr>
<tr class="odd">
<td><code>NLL</code></td>
<td>Final negative log-likelihood value</td>
</tr>
<tr class="even">
<td><code>optimOut</code></td>
<td>Full <code>optim()</code> output object</td>
</tr>
<tr class="odd">
<td><code>MLE</code></td>
<td>Table of parameter estimates, initial values, and standard errors</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="user-interface-functions" class="section level3 hasAnchor" number="4.2.5">
<h3><span class="header-section-number">4.2.5</span> User interface functions:<a href="model-based-functions.html#user-interface-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ul>
<li><strong><code>DoOptDome.LengthComp</code></strong></li>
</ul>
<p>Wrapper function for <code>DoOptDome</code> that handles S4 <code>LengthComp</code> objects with support for both grouped and pooled analysis approaches.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="model-based-functions.html#cb20-1" tabindex="-1"></a><span class="fu">DoOptDome.LengthComp</span>(lifeHistoryObj, fixedFleetPars, LengthCompObj, <span class="at">SizeBins =</span> <span class="cn">NULL</span>, <span class="at">byGroup =</span> <span class="cn">FALSE</span>, <span class="at">Lc =</span> <span class="dv">0</span>, <span class="at">mod =</span> <span class="fu">c</span>(<span class="st">&quot;GTG&quot;</span>, <span class="st">&quot;LBSPR&quot;</span>))</span></code></pre></div>
<p>The <code>DoOptDome.LengthComp</code> function processes S4 LengthComp objects using processLengthCompData(), handles multiple groups either separately (<code>byGroup = TRUE</code>) or pooled (<code>byGroup = FALSE</code>) and returns results appropriate to the analysis approach chosen.</p>
<ul>
<li><strong><code>DoOptDome.aggregated</code></strong></li>
</ul>
<p>Convenience wrapper that always pools (aggregates) multiple groups before optimization:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="model-based-functions.html#cb21-1" tabindex="-1"></a><span class="fu">DoOptDome.aggregated</span>(lifeHistoryObj, fixedFleetPars, LengthCompObj, <span class="at">SizeBins =</span> <span class="cn">NULL</span>, <span class="at">Lc =</span> <span class="dv">0</span>, <span class="at">mod =</span> <span class="fu">c</span>(<span class="st">&quot;GTG&quot;</span>, <span class="st">&quot;LBSPR&quot;</span>))</span></code></pre></div>
<ul>
<li><strong><code>run_grouped_and_pooled</code></strong></li>
</ul>
<p>Convenience function that runs both grouped and pooled optimization analyses on the same dataset:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="model-based-functions.html#cb22-1" tabindex="-1"></a><span class="fu">run_grouped_and_pooled</span>(lifeHistoryObj, fixedFleetPars, LengthCompObj, <span class="at">SizeBins =</span> <span class="cn">NULL</span>, <span class="at">Lc =</span> <span class="dv">0</span>, <span class="at">mod =</span> <span class="st">&quot;GTG&quot;</span>)</span></code></pre></div>
<p>The <code>run_grouped_and_pooled</code> function returns a list with both grouped and pooled results, allowing comparison between approaches.</p>
<p>In Chapter 6, the user will find a step-by-step example of applying the GTG Length-Based SPR model, including dome-shaped selectivity (See section <a href="examples.html#dome-shaped-lbspr">6.2</a> for details).</p>

</div>
</div>
</div>
<h3>References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-coscino_influence_2024" class="csl-entry">
Coscino, Connor L., Lyall Bellquist, William J. Harford, and Brice X. Semmens. 2024. <span>“Influence of Life History Characteristics on Data-Limited Stock Status Assertions and Minimum Size Limit Evaluations Using <span>Length</span>-<span>Based</span> <span>Spawning</span> <span>Potential</span> <span>Ratio</span> (<span>LBSPR</span>).”</span> <em>Fisheries Research</em> 276 (August): 107036. <a href="https://doi.org/10.1016/j.fishres.2024.107036">https://doi.org/10.1016/j.fishres.2024.107036</a>.
</div>
<div id="ref-hommik2020" class="csl-entry">
Hommik, Kristjan, Ciaran Fitzgerald, Finbarr Kelly, and Samuel Shephard. 2020. <span>“Dome-Shaped Selectivity in LB-SPR: Length-Based Assessment of Data-Limited Inland Fish Stocks Sampled with Gillnets.”</span> <em>Fisheries Research</em> 229: 105574.
</div>
<div id="ref-hordyk2016simple" class="csl-entry">
Hordyk, Adrian R, Kotaro Ono, Jeremy D Prince, and Carl J Walters. 2016b. <span>“A Simple Length-Structured Model Based on Life History Ratios and Incorporating Size-Dependent Selectivity: Application to Spawning Potential Ratios for Data-Poor Stocks.”</span> <em>Canadian Journal of Fisheries and Aquatic Sciences</em> 73 (12): 1787–99. <a href="https://doi.org/10.1139/cjfas-2015-0422">https://doi.org/10.1139/cjfas-2015-0422</a>.
</div>
<div id="ref-mildenberger2017" class="csl-entry">
Mildenberger, Tobias K., Michael H. Taylor, and Matthias Wolff. 2017. <span>“TropFishR: An r Package for Fisheries Analysis with Length-Frequency Data.”</span> <em>Methods in Ecology and Evolution</em> 8 (11): 1520–27.
</div>
<div id="ref-millar1997" class="csl-entry">
Millar, Russell B, and Rolf Holst. 1997. <span>“Estimation of Gillnet and Hook Selectivity Using Log-Linear Models.”</span> <em>ICES Journal of Marine Science</em> 54 (3): 471–77. <a href="https://doi.org/10.1006/jmsc.1996.0194">https://doi.org/10.1006/jmsc.1996.0194</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="indicator-based-functions.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="utility-functions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/03-models.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
